# MoonJQ

一个用 MoonBit 语言实现的 jq 命令行 JSON 处理器。

## 🌟 特性

- ✅ **纯字符串操作** - 从零实现所有字符串处理函数
- ✅ **模块化设计** - 清晰的代码结构
- ✅ **可扩展架构** - 易于添加新功能

## 📦 安装

确保已安装 MoonBit 工具链，然后：

```bash
moon install
moon build
```

## 🚀 使用方法

```bash
# 从文件读取 JSON
moon run cmd/main '<jq-query>' <file.json>

# 使用示例数据（内置）
moon run cmd/main '<jq-query>'
```

### 示例

```bash
# 提取字段
echo '{"name": "Alice", "age": 30}' > data.json
moon run cmd/main '.name' data.json
# 输出: "Alice"

# 嵌套字段访问
echo '{"user": {"profile": {"name": "Bob"}}}' > nested.json
moon run cmd/main '.user.profile.name' nested.json
# 输出: "Bob"

# 可选字段访问 (字段不存在时返回 null)
moon run cmd/main '.user.email?' nested.json
# 输出: null

# 逗号操作符 (多个输出)
moon run cmd/main '.name, .age' data.json
# 输出:
# "Alice"
# 30

# 对象构造器
moon run cmd/main '{username: .name, user_age: .age}' data.json
# 输出: {"username":"Alice","user_age":30}

# 数组操作
echo '[1, 2, 3]' > numbers.json
moon run cmd/main '[ .[] | . * 2]' numbers.json
# 输出: [2,4,6]

# pick 函数
echo '{"a": 1, "b": {"c": 2}}' > test.json
moon run cmd/main 'pick(.a, .b.c)' test.json
# 输出: {"a":1,"b":{"c":2}}

# 数组切片
echo '[1,2,3,4,5]' > array.json
moon run cmd/main '.[1:3]' array.json
# 输出: [2,3]

# 替代操作符
moon run cmd/main '.missing // "default"' data.json
# 输出: "default"
```

## 📚 已实现功能

### ✅ 基础过滤器 (Basic Filters)

| 功能 | 语法 | 说明 | 状态 |
|------|------|------|------|
| 身份操作符 | `.` | 返回输入本身 | ✅ |
| 字段访问 | `.field` | 访问对象字段 | ✅ |
| 嵌套字段访问 | `.field1.field2` | 多层字段访问 | ✅ **新增** |
| 可选字段访问 | `.field?` | 不存在时不报错 | ✅ **新增** |
| 数组索引 | `.[n]` | 访问数组第n个元素 | ✅ |
| 负索引 | `.[-n]` | 从数组末尾索引 | ✅ |
| 数组切片 | `.[n:m]` | 切片操作 | ✅ |
| 空起始切片 | `.[:m]` | 从开始到m | ✅ |
| 空结束切片 | `.[n:]` | 从n到结束 | ✅ |
| 数组迭代 | `.[]` | 迭代数组所有元素 | ✅ |
| 字段数组迭代 | `.field[]` | 字段+数组迭代 | ✅ |
| 递归下降 | `..` | 递归获取所有值 | ❌ 未实现 |
| 管道 | `|` | 连接多个过滤器 | ✅ |
| 数组构造器 | `[expr]` | 构建新数组 | ✅ |
| 对象构造器 | `{key: value}` | 构建新对象 | ✅ **新增** |
| 逗号操作符 | `,` | 产生多个输出 | ✅ **新增** |
| 替代操作符 | `//` | 空值合并 | ✅ |

### ✅ 内置函数

| 功能 | 语法 | 说明 | 状态 |
|------|------|------|------|
| 对象键 | `keys` | 获取对象所有键 | ✅ |
| 对象值 | `values` | 获取对象所有值 | ✅ |
| 长度 | `length` | 获取长度 | ✅ |
| Pick函数 | `pick(.a, .b.c)` | 选择指定字段/索引 | ✅ |
| 类型 | `type` | 获取值类型 | ✅ **已实现** |
| 空值 | `empty` | 不产生输出 | ✅ **已实现** |
| 加法 | `add` | 数组求和/字符串连接 | ✅ **已实现** |
| 映射 | `map(expr)` | 对每个元素应用表达式 | ✅ **已实现** |
| 过滤 | `select(cond)` | 选择满足条件的元素 | ✅ **已实现** |
| 检查键 | `has(key)` | 检查键是否存在 | ✅ **已实现** |
| 最小值 | `min` | 数组最小值 | ✅ **已实现** |
| 最大值 | `max` | 数组最大值 | ✅ **已实现** |
| 排序 | `sort` | 数组排序 | ✅ **已实现** |
| 反转 | `reverse` | 数组反转 | ✅ **已实现** |
| 去重 | `unique` | 数组去重 | ✅ **已实现** |

### ✅ 算术运算

| 功能 | 语法 | 说明 | 状态 |
|------|------|------|------|
| 乘法 | `* n` | 乘法运算 | ✅ |
| 加法 | `+ n` | 加法运算 | ✅ |
| 减法 | `- n` | 减法运算 | ✅ |
| 除法 | `/ n` | 除法运算 | ✅ |

### ✅ 条件和比较

| 功能 | 语法 | 说明 | 状态 |
|------|------|------|------|
| 相等 | `==` | 相等比较 | ✅ **已实现** |
| 不等 | `!=` | 不等比较 | ✅ **已实现** |
| 小于 | `<` | 小于比较 | ✅ **已实现** |
| 大于 | `>` | 大于比较 | ✅ **已实现** |
| 小于等于 | `<=` | 小于等于比较 | ✅ **已实现** |
| 大于等于 | `>=` | 大于等于比较 | ✅ **已实现** |
| 逻辑与 | `and` | 逻辑与运算 | ✅ **已实现** |
| 逻辑或 | `or` | 逻辑或运算 | ✅ **已实现** |
| 逻辑非 | `not` | 逻辑非运算 | ✅ **已实现** |
| 条件表达式 | `if-then-else` | 条件分支 | ❌ 未实现 |

### ❌ 高级特性

| 功能 | 语法 | 说明 | 状态 |
|------|------|------|------|
| 归约 | `reduce` | 归约操作 | ❌ 未实现 |
| 自定义函数 | `def` | 定义函数 | ❌ 未实现 |
| 变量绑定 | `as $var` | 绑定变量 | ❌ 未实现 |
| 错误处理 | `try-catch` | 捕获错误 | ❌ 未实现 |

## 🎯 实现进度

### 总体进度: 约 55%

- **基础过滤器**: **94%** ⭐⭐⭐⭐⭐⭐⭐⭐⭐ ✅ **完成！**
- **内置函数**: **100%** ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐ ✅ **全部完成！**
- **算术运算**: **100%** ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐ ✅ **完成！**
- **条件和比较**: **90%** ⭐⭐⭐⭐⭐⭐⭐⭐⭐ ✅ **基本完成！**
- **高级特性**: 0%

## 🛠️ 开发

### 项目结构

```
moonjq/
├── cmd/
│   ├── main/
│   │   └── main.mbt          # 主入口
│   └── lib/
│       └── Filter/
│           ├── filter.mbt     # 核心过滤器实现
│           └── moon.pkg.json
├── moon.mod.json
└── README.md
```

### 运行测试

```bash
# 测试基本查询
moon run cmd/main '.' test.json

# 测试数组操作
moon run cmd/main '.[]' array.json

# 测试管道
moon run cmd/main '.field | length' test.json
```

## 📖 技术细节

### 自实现的工具函数

```moonbit
substring_safe()         // 安全字符串切片
trim_string()           // 字符串trim
string_starts_with()    // 前缀匹配
string_ends_with()      // 后缀匹配
string_contains()       // 包含检查
string_find()           // 查找子串
string_to_int()         // 字符串转整数
parse_double()          // 手动解析浮点数
split_array_elements()  // 分割数组元素
split_object_pairs()    // 分割对象键值对
```

## 🗺️ 开发路线图

### Phase 1: 基础过滤器完善 ✅ **完成！**
- [x] 身份操作符 `.`
- [x] 字段访问 `.field`
- [x] 嵌套字段访问 `.field1.field2` ✨
- [x] 可选字段访问 `.field?` ✨
- [x] 数组索引 `.[n]` (支持负索引)
- [x] 数组切片 `.[n:m]` (支持空起始/结束)
- [x] 数组迭代 `.[]`
- [x] 字段数组迭代 `.field[]`
- [x] 管道 `|`
- [x] 数组构造器 `[...]` (支持管道和展开)
- [x] 对象构造器 `{key: value}` ✨
- [x] 逗号操作符 `,` (完整实现) ✨
- [x] 替代操作符 `//`
- [ ] 递归下降 `..` (可选，低优先级)

### Phase 2: 条件和比较 ✅ **基本完成！**
- [x] 比较操作符 `==`, `!=`, `<`, `>`, `<=`, `>=` ✨
- [x] 逻辑运算 `and`, `or`, `not` ✨
- [ ] 条件表达式 `if-then-else`

### Phase 3: 核心内置函数 ✅ **全部完成！**
- [x] `select(condition)` - 过滤 ✨
- [x] `map(expr)` - 映射 ✨
- [x] `type` - 类型检查 ✨
- [x] `add` - 求和/连接 ✨
- [x] `has(key)` - 键检查 ✨
- [x] `empty` - 空输出 ✨
- [x] `sort`, `unique` - 排序和去重 ✨
- [x] `min`, `max` - 最小/最大值 ✨
- [x] `reverse` - 反转 ✨

### Phase 4: 高级特性
- [ ] `reduce` - 归约
- [ ] 变量绑定 `as $var`
- [ ] 自定义函数 `def`
- [ ] 错误处理 `try-catch`

### Phase 5: 字符串和正则
- [ ] 字符串函数 `split`, `join`, `contains`
- [ ] 正则表达式 `test`, `match`, `capture`

## 🤝 贡献

欢迎贡献！请遵循以下原则：

2. **避免外部依赖** - 尽量自己实现工具函数
3. **保持代码清晰** - 添加注释说明
4. **更新 README** - 实现新功能后更新本文档

## 📝 更新日志

### 2025-01-30 (深夜 Part 2) 🔥
- ✅ 实现 `min`, `max` 函数 (数组最小/最大值)
- ✅ 实现 `sort` 函数 (数组排序，支持数字和字符串)
- ✅ 实现 `reverse` 函数 (数组反转)
- ✅ 实现 `unique` 函数 (数组去重)
- ✅ 实现逻辑运算符 `and`, `or`, `not`
- 🎉 **Phase 2 & Phase 3 全部完成！**
- 🎊 **内置函数达到 100% 完成！**
- 📊 **总体进度从 45% 跃升到 55%！**

### 2025-01-30 (深夜 Part 1) 
- ✅ 实现 `type` 函数 (获取值类型)
- ✅ 实现 `add` 函数 (数组求和/字符串连接)
- ✅ 实现 `map(expr)` 函数 (映射)
- ✅ 实现 `select(condition)` 函数 (条件过滤)
- ✅ 实现 `has(key)` 函数 (键检查)
- ✅ 实现 `empty` 函数 (空输出)
- ✅ 实现比较操作符 `==`, `!=`, `<`, `>`, `<=`, `>=`
- 🎉 **Phase 2 & Phase 3 核心功能完成！**
- 📊 **总体进度从 30% 跃升到 45%！**

### 2025-01-30 (晚上)
- ✅ 实现嵌套字段访问 `.field1.field2.field3`
- ✅ 实现可选字段访问 `.field?` (不存在返回 null)
- ✅ 实现对象构造器 `{key: value, ...}`
- ✅ 实现逗号操作符 `,` (多个输出)
- ✅ 支持对象构造器中的表达式键和值
- 🎉 **基础过滤器完成度达到 94%！Phase 1 基本完成！**
- 📊 **总体进度提升到 30%**

### 2025-01-30 (下午)
- ✅ 实现数组切片 `.[n:m]`、`.[:m]`、`.[n:]`
- ✅ 实现替代操作符 `//` (空值合并)
- ✅ 支持切片中的负索引
- ✅ 更新 README 文档
- 📊 基础过滤器完成度提升到 65%

### 2025-01-30 (上午)
- ✅ 实现 `pick()` 函数（对象和数组）
- ✅ 实现数组构造器 `[...]`
- ✅ 实现算术运算 `*`, `+`, `-`, `/`
- ✅ 实现字段数组迭代 `.field[]`
- ✅ 完善管道在数组构造器中的支持

### 2025-01-29
- ✅ 初始实现基础过滤器
- ✅ 实现身份操作符 `.`
- ✅ 实现字段访问 `.field`
- ✅ 实现数组索引 `.[n]`（支持负索引）
- ✅ 实现数组迭代 `.[]`
- ✅ 实现管道 `|`
- ✅ 实现 `keys`, `values`, `length`

## 📄 许可证

MIT License

## 🙏 致谢

- [jq](https://jqlang.org/) - 原始 jq 实现
- [MoonBit](https://www.moonbitlang.com/) - MoonBit 编程语言
