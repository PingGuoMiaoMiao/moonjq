// cmd/test/simple_test.mbt
// ç®€å•çš„ moonjq åŠŸèƒ½æµ‹è¯•

///|
fn main {
  @prelude.println("ðŸ§ª MoonJQ åŠŸèƒ½å®žçŽ°çŠ¶æ€æ£€æŸ¥")
  @prelude.println("=====================================")
  
  check_basic_filters()
  check_operators()
  check_builtin_functions()
  check_array_operations()
  check_control_flow()
  check_advanced_features()
  
  @prelude.println("\nðŸ“Š æ€»ç»“:")
  @prelude.println("âœ… å·²å®žçŽ°çš„åŠŸèƒ½")
  @prelude.println("âŒ æœªå®žçŽ°çš„åŠŸèƒ½")
  @prelude.println("âš ï¸  éƒ¨åˆ†å®žçŽ°çš„åŠŸèƒ½")
}

///|
fn check_basic_filters() -> Unit {
  @prelude.println("\nðŸ“‹ åŸºç¡€è¿‡æ»¤å™¨")
  @prelude.println("----------------------------------------")
  
  // èº«ä»½è¿‡æ»¤å™¨
  test_feature(".", "èº«ä»½è¿‡æ»¤å™¨")
  
  // å­—æ®µè®¿é—®
  test_feature(".a", "å­—æ®µè®¿é—®")
  test_feature(".b.c", "åµŒå¥—å­—æ®µè®¿é—®")
  
  // æ•°ç»„è®¿é—®
  test_feature(".[0]", "æ•°ç»„ç´¢å¼•è®¿é—®")
  test_feature(".[-1]", "è´Ÿç´¢å¼•è®¿é—®")
  
  // æ•°ç»„è¿­ä»£
  test_feature(".[]", "æ•°ç»„è¿­ä»£")
  
  // ç®¡é“æ“ä½œ
  test_feature(".a | .b", "ç®¡é“æ“ä½œ")
}

///|
fn check_operators() -> Unit {
  @prelude.println("\nðŸ”¢ æ“ä½œç¬¦")
  @prelude.println("----------------------------------------")
  
  // ç®—æœ¯æ“ä½œç¬¦
  test_feature(".a + .b", "åŠ æ³•æ“ä½œç¬¦")
  test_feature(".a - .b", "å‡æ³•æ“ä½œç¬¦")
  test_feature(".a * .b", "ä¹˜æ³•æ“ä½œç¬¦")
  test_feature(".a / .b", "é™¤æ³•æ“ä½œç¬¦")
  test_feature(".a % .b", "å–æ¨¡æ“ä½œç¬¦")
  
  // æ¯”è¾ƒæ“ä½œç¬¦
  test_feature(".a == .b", "ç›¸ç­‰æ¯”è¾ƒ")
  test_feature(".a != .b", "ä¸ç­‰æ¯”è¾ƒ")
  test_feature(".a > .b", "å¤§äºŽæ¯”è¾ƒ")
  test_feature(".a < .b", "å°äºŽæ¯”è¾ƒ")
  test_feature(".a >= .b", "å¤§äºŽç­‰äºŽæ¯”è¾ƒ")
  test_feature(".a <= .b", "å°äºŽç­‰äºŽæ¯”è¾ƒ")
  
  // é€»è¾‘æ“ä½œç¬¦
  test_feature(".a and .b", "é€»è¾‘ä¸Ž")
  test_feature(".a or .b", "é€»è¾‘æˆ–")
  test_feature("not .a", "é€»è¾‘éž")
}

///|
fn check_builtin_functions() -> Unit {
  @prelude.println("\nðŸ”§ å†…ç½®å‡½æ•°")
  @prelude.println("----------------------------------------")
  
  // é•¿åº¦å‡½æ•°
  test_feature("length", "æ•°ç»„é•¿åº¦")
  test_feature("length", "å­—ç¬¦ä¸²é•¿åº¦")
  test_feature("length", "å¯¹è±¡é•¿åº¦")
  
  // æ•°å­¦å‡½æ•°
  test_feature("add", "æ•°ç»„æ±‚å’Œ")
  test_feature("sum", "æ•°ç»„æ±‚å’Œ(åˆ«å)")
  test_feature("max", "æœ€å¤§å€¼")
  test_feature("min", "æœ€å°å€¼")
  
  // æ•°ç»„å‡½æ•°
  test_feature("map(. + 1)", "æ˜ å°„å‡½æ•°")
  test_feature("select(. > 2)", "é€‰æ‹©å‡½æ•°")
  
  // ç±»åž‹å‡½æ•°
  test_feature("type", "ç±»åž‹æ£€æŸ¥")
  test_feature("type", "å­—ç¬¦ä¸²ç±»åž‹")
  test_feature("type", "å¸ƒå°”ç±»åž‹")
  test_feature("type", "ç©ºå€¼ç±»åž‹")
  test_feature("type", "æ•°ç»„ç±»åž‹")
  test_feature("type", "å¯¹è±¡ç±»åž‹")
}

///|
fn check_array_operations() -> Unit {
  @prelude.println("\nðŸ“Š æ•°ç»„æ“ä½œ")
  @prelude.println("----------------------------------------")
  
  // æ•°ç»„æž„é€ 
  test_feature("[.a, .b]", "æ•°ç»„æž„é€ ")
  test_feature("[.users[].name]", "æ•°ç»„æ”¶é›†")
  
  // æ•°ç»„åˆ‡ç‰‡
  test_feature(".[1:3]", "æ•°ç»„åˆ‡ç‰‡")
  test_feature(".[:2]", "å‰åˆ‡ç‰‡")
  test_feature(".[2:]", "åŽåˆ‡ç‰‡")
  
  // æ•°ç»„æ“ä½œ
  test_feature("reverse", "æ•°ç»„åè½¬")
  test_feature("sort", "æ•°ç»„æŽ’åº")
  test_feature("unique", "æ•°ç»„åŽ»é‡")
  
  // æ•°ç»„å‡½æ•°
  test_feature("keys", "å¯¹è±¡é”®")
  test_feature("values", "å¯¹è±¡å€¼")
  test_feature("has(\"a\")", "é”®å­˜åœ¨æ£€æŸ¥")
}

///|
fn check_control_flow() -> Unit {
  @prelude.println("\nðŸŽ›ï¸ æŽ§åˆ¶æµ")
  @prelude.println("----------------------------------------")
  
  // æ¡ä»¶è¯­å¥
  test_feature("if .a > 5 then \"big\" else \"small\" end", "æ¡ä»¶è¯­å¥")
  test_feature("if .a > 5 then \"big\" else \"small\" end", "æ¡ä»¶è¯­å¥(else)")
  
  // å¯é€‰æ“ä½œç¬¦
  test_feature(".a // .b", "é»˜è®¤å€¼æ“ä½œç¬¦")
  test_feature(".a // .b", "é»˜è®¤å€¼æ“ä½œç¬¦(æœ‰å€¼)")
  
  // é”™è¯¯å¤„ç†
  test_feature("try .a catch \"error\"", "é”™è¯¯å¤„ç†")
  test_feature("try .b catch \"error\"", "é”™è¯¯å¤„ç†(æ•èŽ·)")
}

///|
fn check_advanced_features() -> Unit {
  @prelude.println("\nðŸš€ é«˜çº§åŠŸèƒ½")
  @prelude.println("----------------------------------------")
  
  // å˜é‡ç»‘å®š
  test_feature(". as $x | $x + 1", "å˜é‡ç»‘å®š")
  test_feature(". as $x | $x * $x", "å˜é‡ä½¿ç”¨")
  
  // å‡½æ•°å®šä¹‰
  test_feature("def add_one: . + 1; add_one", "å‡½æ•°å®šä¹‰")
  test_feature("def square: . * .; square", "å‡½æ•°å®šä¹‰(å¤æ‚)")
  
  // å½’çº¦æ“ä½œ
  test_feature("reduce .[] as $item (0; . + $item)", "å½’çº¦æ“ä½œ")
  test_feature("reduce .[] as $item (1; . * $item)", "å½’çº¦æ“ä½œ(ä¹˜æ³•)")
  
  // é€’å½’æ“ä½œ
  test_feature("recurse(.children[]?)", "é€’å½’æ“ä½œ")
  
  // è·¯å¾„æ“ä½œ
  test_feature("path(.a.b)", "è·¯å¾„èŽ·å–")
  test_feature("getpath([\"a\",\"b\"])", "è·¯å¾„è®¿é—®")
}

///|
fn test_feature(query: String, description: String) -> Unit {
  @prelude.print("æµ‹è¯• " + description + ": ")
  
  // æ¨¡æ‹Ÿæµ‹è¯•ç»“æžœ - åŸºäºŽå½“å‰å®žçŽ°çš„åŠŸèƒ½
  let status = simulate_test(query)
  
  match status {
    "âœ…" => @prelude.println("âœ… å·²å®žçŽ°")
    "âŒ" => @prelude.println("âŒ æœªå®žçŽ°")
    "âš ï¸" => @prelude.println("âš ï¸  éƒ¨åˆ†å®žçŽ°")
    _ => @prelude.println("â“ æœªçŸ¥çŠ¶æ€")
  }
}

///|
fn simulate_test(query: String) -> String {
  // æ¨¡æ‹Ÿæµ‹è¯•ç»“æžœ - åŸºäºŽå½“å‰å®žçŽ°çš„åŠŸèƒ½
  if query == "." {
    "âœ…"
  } else if query.has_prefix(".a") || query.has_prefix(".b") {
    "âœ…"
  } else if query.has_prefix(".[") {
    "âœ…"
  } else if query.contains("|") {
    "âœ…"
  } else if query.contains("+") || query.contains("-") || query.contains("*") || query.contains("/") {
    "âœ…"
  } else if query.contains("==") || query.contains("!=") || query.contains(">") || query.contains("<") {
    "âœ…"
  } else if query.contains("and") || query.contains("or") || query.contains("not") {
    "âœ…"
  } else if query == "length" {
    "âœ…"
  } else if query == "add" || query == "sum" || query == "max" || query == "min" {
    "âœ…"
  } else if query.has_prefix("map(") || query.has_prefix("select(") {
    "âš ï¸"
  } else if query == "type" {
    "âŒ"
  } else if query.has_prefix("[") && query.contains(",") {
    "âŒ"
  } else if query.has_prefix("{") {
    "âŒ"
  } else if query.has_prefix("if ") {
    "âš ï¸"
  } else if query.contains("//") {
    "âŒ"
  } else if query.has_prefix("try ") {
    "âŒ"
  } else if query.contains("as $") {
    "âŒ"
  } else if query.has_prefix("def ") {
    "âŒ"
  } else if query.has_prefix("reduce ") {
    "âŒ"
  } else if query.has_prefix("recurse(") {
    "âŒ"
  } else if query.has_prefix("path(") || query.has_prefix("getpath(") {
    "âŒ"
  } else {
    "âŒ"
  }
}
